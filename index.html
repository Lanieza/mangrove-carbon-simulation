<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mangrove-Carbon Simulation</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        body { display: flex; flex-direction: column; align-items: center; font-family: Arial, sans-serif; background-color: #e0f7fa; }
        .container { display: flex; }
        .controls, canvas { margin: 20px; }
        .legend { display: flex; gap: 15px; margin-bottom: 10px; }
        .legend div { display: flex; align-items: center; gap: 8px; font-size: 16px; }
        .legend i { font-size: 20px; }
        .control-group { display: flex; align-items: center; gap: 10px; margin-bottom: 5px; }
    </style>
</head>
<body>
    <h1>Mangrove-Carbon Simulation</h1>
    <div class="legend">
        <div><i class="fas fa-tree" style="color:#4CAF50;"></i> Mangrove</div>
        <div>
            <canvas id="carLegend" width="30" height="35"></canvas> Vehicles
        </div>
        <div><i class="fas fa-home" style="color:#FF9800;"></i> Houses</div>
        <div><i class="fas fa-industry" style="color:#9E9E9E;"></i> Factories</div>
        <div>
            <canvas id="peopleLegend" width="30" height="30"></canvas> Population
        </div>
    </div>    
    <div class="container">
        <div class="controls">
            <div class="control-group">
                <label>Sea Temperature:</label> 
                <input type="range" id="temp" min="20" max="35" value="25" oninput="updateSimulation()">
            </div>
            <div class="control-group">
                <label>Mangrove Coverage:</label>
                <input type="range" id="mangrove" min="0" max="100" value="50" oninput="updateSimulation()">
            </div>
            <div class="control-group">
                <label>Vehicles:</label>
                <input type="range" id="vehicles" min="0" max="100" value="50" oninput="updateSimulation()">
            </div>
            <div class="control-group">
                <label>Houses:</label>
                <input type="range" id="houses" min="0" max="100" value="50" oninput="updateSimulation()">
            </div>
            <div class="control-group">
                <label>Factories:</label>
                <input type="range" id="factories" min="0" max="100" value="50" oninput="updateSimulation()">
            </div>
            <div class="control-group">
                <label>Population:</label>
                <input type="range" id="population" min="0" max="100" value="50" oninput="updateSimulation()">
            </div>
        </div>
        <canvas id="simulationCanvas" width="1000" height="650" style="border: 1px solid black;"></canvas>
    </div>
    <canvas id="carbonGraph" width="600" height="300"></canvas>
    
    <script>
        //Drawing Legend
        function drawLegendCar() {
            let canvas = document.getElementById("carLegend");
            let ctx = canvas.getContext("2d");

            ctx.fillStyle = "blue"; // Car body color
            ctx.fillRect(5, 10, 15, 20); // Car body

            ctx.fillStyle = "lightgray"; // Car body color
            ctx.fillRect(8, 14, 9, 12); // Car body

            ctx.fillStyle = "black"; // Wheels
            ctx.fillRect(1, 24, 3, 3); // Left wheel
            ctx.fillRect(21, 24, 3, 3); // Right wheel

            ctx.fillRect(1, 12, 3, 3); // Left wheel
            ctx.fillRect(21, 12, 3, 3); // Right wheel

            ctx.fillStyle = "red"; // Car body color
            ctx.fillRect(8, 30, 8, 3); // Car body

            ctx.fillStyle = "yellow"; // Car body color
            ctx.fillRect(8, 7, 8, 3); // Car body

            
        }

        function drawLegendPerson() {
            let canvas = document.getElementById("peopleLegend");
            let ctx = canvas.getContext("2d");

            ctx.fillStyle = "#FDD835"; // Head
            ctx.beginPath();
            ctx.arc(15, 8, 3, 0, Math.PI * 2);
            ctx.fill();

            ctx.fillStyle = "#9C27B0"; // Body
            ctx.fillRect(12, 13, 6, 10);

            ctx.fillStyle = "black"; // Legs
            ctx.fillRect(12, 23, 2, 5);
            ctx.fillRect(16, 23, 2, 5);
        }

        window.onload = function () {
            drawLegendCar();
            drawLegendPerson();
        };

        const ctx = document.getElementById('carbonGraph').getContext('2d');
        const simCanvas = document.getElementById('simulationCanvas');
        const simCtx = simCanvas.getContext('2d');

        let carbonData = Array(12).fill(50);
        const carbonChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: Array.from({ length: 12 }, (_, i) => `${i + 1} Month`),
                datasets: [{ label: 'Carbon Level', data: carbonData, borderColor: 'red', fill: false }]
            },
            options: { responsive: false }
        });

        function updateSimulation() {
            let temp = document.getElementById('temp').value;
            let mangrove = document.getElementById('mangrove').value;
            let vehicles = document.getElementById('vehicles').value;
            let houses = document.getElementById('houses').value;
            let factories = document.getElementById('factories').value;
            let population = document.getElementById('population').value;

            let carbonLevel = 100 - mangrove * 0.5 + vehicles * 0.3 + factories * 0.4 + houses * 0.2 + population * 0.2 + (temp - 25) * 0.5;
            carbonData.push(carbonLevel);
            carbonData.shift();
            carbonChart.update();

            simCtx.clearRect(0, 0, simCanvas.width, simCanvas.height);
            
            drawSea();

            // Draw Road (Centered)
            simCtx.fillStyle = "#707070"; // Gray road
            let roadWidth = 200;
            let roadX = (simCanvas.width - roadWidth) / 2 - 50;
            simCtx.fillRect(roadX, 0, roadWidth, simCanvas.height);

            // Draw Lane Markings
            simCtx.strokeStyle = "white";
            simCtx.lineWidth = 12;
            simCtx.setLineDash([20, 20]); // Dashed lines
            simCtx.beginPath();
            simCtx.moveTo(roadX + roadWidth / 2, 0);
            simCtx.lineTo(roadX + roadWidth / 2, simCanvas.height);
            simCtx.stroke();
            simCtx.setLineDash([]); // Reset dash style

            // Draw Land (On Top of Road, Right Side)
            simCtx.fillStyle = "#CD853F"; // Brown for land
            let landX = roadX + roadWidth; // Right side of the road
            simCtx.fillRect(landX, 0, simCanvas.width - landX, simCanvas.height);

            let carCount = Math.floor(vehicles / 10); // Adjust density
            
            if (carPositions.length !== carCount) {
                generateCarPositions(carCount); // Only update when needed
            }

            carPositions.forEach(car => drawCar(simCtx, car.x, car.y, car.color));

            initializePeople(population); 
            drawPeople(simCtx);
        }

        // Call this once when population changes, NOT in updateSimulation
        function initializePeople(population) {
            let count = Math.floor(population / 5);
            if (peoplePositions.length !== count) {
                generatePeoplePositions(count);
            }
        }

        // ðŸŽ¨ Improve 2D Cartoon Style for People
        function drawPeople(ctx) {
            peoplePositions.forEach(person => {
                // Draw Head (Circle)
                ctx.fillStyle = "#FDD835"; // Yellow head
                ctx.beginPath();
                ctx.arc(person.x, person.y, 5, 0, Math.PI * 2);
                ctx.fill();
                // ctx.stroke();

                // Draw Body (Rectangle)
                ctx.fillStyle = "#9C27B0"; // Purple shirt
                ctx.fillRect(person.x - 5, person.y + 10, 10, 15);

                // Draw Legs (Two small rectangles)
                ctx.fillStyle = "black";
                ctx.fillRect(person.x - 5, person.y + 25, 4, 10);
                ctx.fillRect(person.x + 1, person.y + 25, 4, 10);
            });
        }

        let peoplePositions = [];

        function generatePeoplePositions(count) {
            peoplePositions = []; // Reset list
            let landX = (simCanvas.width - 200) / 2 + 150; // Land starts here
            let landWidth = simCanvas.width - landX;
            let personSize = 20;
            let buffer = 10; // Avoid overlap
            let maxAttempts = 100;

            for (let i = 0; i < count; i++) {
                let attempts = 0;
                let newPerson;
                let collision;

                do {
                    let personX = landX + Math.random() * (landWidth - personSize);
                    let personY = Math.random() * (simCanvas.height - personSize);
                    newPerson = { x: personX, y: personY };
                    collision = peoplePositions.some(person => checkCollision(person, newPerson, personSize, personSize, buffer));
                    attempts++;
                } while (collision && attempts < maxAttempts);

                if (!collision) {
                    peoplePositions.push(newPerson);
                }
            }
        }

        // Call initializePeople() once at the start or when population changes
        initializePeople();

        function drawCar(ctx, x, y, color) {
            let carWidth = 40;  
            let carHeight = 70;  

            // Draw car body
            ctx.fillStyle = color;
            ctx.fillRect(x, y, carWidth, carHeight);  

            // Roof (Windows Area)
            ctx.fillStyle = "lightblue";
            ctx.fillRect(x + 8, y + 15, carWidth - 16, carHeight - 30);

            // Wheels
            ctx.fillStyle = "black";
            ctx.fillRect(x - 5, y + 5, 10, 15);   // Front-left wheel
            ctx.fillRect(x + carWidth - 5, y + 5, 10, 15);  // Front-right wheel
            ctx.fillRect(x - 5, y + carHeight - 20, 10, 15);  // Rear-left wheel
            ctx.fillRect(x + carWidth - 5, y + carHeight - 20, 10, 15);  // Rear-right wheel

            // Headlights (Front)
            ctx.fillStyle = "yellow";
            ctx.fillRect(x + 10, y - 5, 20, 5);

            // Taillights (Rear)
            ctx.fillStyle = "red";
            ctx.fillRect(x + 10, y + carHeight, 20, 5);
        }



        let carPositions = []; // Store car positions

        function generateCarPositions(count) {
            carPositions = []; // Reset the car list
            let roadX = (simCanvas.width - 200) / 2 - 50;
            let roadWidth = 200;
            let carWidth = 30;
            let carHeight = 50;
            let buffer = 10; // Extra space to prevent collisions
            let maxAttempts = 100; // Prevent infinite loops
            let carColors = ["blue", "red"];

            for (let i = 0; i < count; i++) {
                let attempts = 0;
                let newCar;
                let collision;

                do {
                    let carX = roadX + Math.random() * (roadWidth - carWidth);
                    let carY = Math.random() * (simCanvas.height - carHeight);
                    let color = carColors[Math.floor(Math.random() * carColors.length)];
                    newCar = { x: carX, y: carY, color: color };
                    collision = carPositions.some(car => checkCollision(car, newCar, carWidth, carHeight, buffer));
                    attempts++;
                } while (collision && attempts < maxAttempts);

                if (!collision) {
                    carPositions.push(newCar);
                }
            }
        }

        function checkCollision(car1, car2, carWidth, carHeight, buffer = 0) {
            return (
                car1.x < car2.x + carWidth + buffer &&
                car1.x + carWidth + buffer > car2.x &&
                car1.y < car2.y + carHeight + buffer &&
                car1.y + carHeight + buffer > car2.y
            );
        }


        let waveOffset = 0; // Add a wave offset

        function drawSea() {
            simCtx.fillStyle = '#a3d5ff';
            simCtx.fillRect(0, 0, simCanvas.width * 0.3, simCanvas.height);

            let amplitude = 20;
            let frequency = 0.02;
            let numWaves = 5;

            simCtx.fillStyle = '#4da6ff';
            simCtx.beginPath();

            for (let i = 0; i < numWaves; i++) {
                let phase = i * Math.PI / numWaves;

                simCtx.moveTo(0, 0);
                for (let y = 0; y <= simCanvas.height; y += 5) {
                    let waveX = Math.sin((y + waveOffset + phase) * frequency) * amplitude + 150;
                    simCtx.lineTo(waveX, y);
                }
                simCtx.lineTo(0, simCanvas.height);
            }

            simCtx.closePath();
            simCtx.fill();

            // **Fix Shoreline Drawing**
            simCtx.fillStyle = '#c2a772'; // Sand color
            simCtx.beginPath();
            for (let y = 0; y <= simCanvas.height; y += 10) {
                let shorelineX = simCanvas.width * 0.26 + Math.sin((y + waveOffset) * 0.02) * 8;
                simCtx.lineTo(shorelineX, y);
            }
            simCtx.lineTo(simCanvas.width * 0.4, simCanvas.height);
            simCtx.lineTo(simCanvas.width * 0.4, 0);
            simCtx.closePath();
            simCtx.fill();
        }

        function animate() {
            waveOffset += 1; // Move the wave
            updateSimulation(); // Redraw the whole simulation
            requestAnimationFrame(animate); // Loop animation
        }

        // Start animation loop
        animate();

        document.querySelectorAll('input').forEach(input => input.addEventListener('input', updateSimulation));
        updateSimulation();
    </script>
</body>
</html>